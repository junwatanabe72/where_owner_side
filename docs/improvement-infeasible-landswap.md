# 不成立案件の差額明示機能 - 改善完了

**実装日**: 2025-10-21
**対象**: 等価交換シミュレーター
**重要度**: Medium（意思決定支援）

## 改善内容

### 背景

バグ修正により、不成立の等価交換シナリオでは `NPV=0` となり、キャッシュフローも0になりました。これは計算破綻を防ぐ安全策として正しい動作ですが、**どれだけの条件変更が必要か**が不明瞭でした。

### 実装した改善

不成立案件において、以下の情報を明示的に表示するようにしました：

#### 1. NPVに不足額を反映

```typescript
// 不成立の場合はCFを0にするが、NPVには不足額を反映
if (!feasible || ownerAcquisitionValue === 0) {
  annualCF.push({ year: acquisitionYear, cf: 0, cumulative: 0 });
  // 不足額をNPVに反映（意思決定のため）
  npv = landBudget - landValue;
}
```

- **NPV = 土地対価上限 - 土地価値**
- 負の値になり、不足額が一目でわかる

#### 2. 注記に具体的な改善案を追加

```typescript
if (!feasible) {
  const deficit = landValue - landBudget;
  const requiredPriceIncrease = deficit / plannedGfa;

  notes.push(`⚠️ 不成立。土地対価${Math.round(landBudget / 1000000)}百万円 < 土地価値${Math.round(landValue / 1000000)}百万円。`);
  notes.push(`不足額: ${Math.round(deficit / 1000000)}百万円（${(deficit / landValue * 100).toFixed(1)}%）`);
  notes.push(`💡 改善案: 売却単価を${Math.round(requiredPriceIncrease / 1000)}千円/㎡以上引き上げる、またはコスト${(deficit / totalCost * 100).toFixed(1)}%削減が必要。`);
}
```

## 表示例

### 成立案件（従来通り）

```
NPV: +150,000,000円
IRR: 8.5%

注記:
✓ 成立可能。オーナー取得価値200百万円（約250㎡）。
取得住戸を賃貸運用（想定賃料750,000円/月）。
```

### 不成立案件（改善後）

```
NPV: -80,000,000円  ← 不足額を明示
IRR: N/A
実現可否: 要検討

注記:
⚠️ 不成立。土地対価120百万円 < 土地価値200百万円。
不足額: 80百万円（40.0%）
💡 改善案: 売却単価を100千円/㎡以上引き上げる、またはコスト13.3%削減が必要。
```

## 意思決定への影響

### Before（改善前）
```
NPV: 0円
実現可否: 要検討
→ 何をどれだけ変更すればよいか不明
```

### After（改善後）
```
NPV: -80,000,000円
不足額: 80百万円（40.0%）
改善案: 売却単価を100千円/㎡引き上げ または コスト13.3%削減
→ 具体的なアクションが明確
```

## 改善案の計算ロジック

### 1. 不足額の計算

```typescript
const deficit = landValue - landBudget;
```

- 土地価値 - 土地対価上限 = 不足している金額

### 2. 必要な売却単価の引き上げ

```typescript
const requiredPriceIncrease = deficit / plannedGfa;
```

- 不足額を計画延床面積で割ることで、1㎡あたりの必要値上げ額を算出

### 3. 必要なコスト削減率

```typescript
const requiredCostReduction = (deficit / totalCost * 100).toFixed(1);
```

- 不足額を総コストで割ることで、必要なコスト削減率を算出

## 使用例

### ケース1: 売却単価が低い

**入力**:
- 土地価値: 2億円
- 売却単価: 60万円/㎡
- 計画延床: 1,000㎡

**結果**:
- NPV: -5,000万円
- 改善案: 売却単価を50千円/㎡引き上げ（60万円 → 65万円）

### ケース2: 建築コストが高い

**入力**:
- 土地価値: 2億円
- 建築コスト: 50万円/㎡
- ディベ利益率: 20%

**結果**:
- NPV: -3,000万円
- 改善案: コスト10%削減（建築コスト50万円 → 45万円）

### ケース3: ディベ利益率が高い

**入力**:
- 土地価値: 2億円
- ディベ利益率: 25%

**結果**:
- NPV: -4,000万円
- 改善案: 利益率を20%に調整、またはGDVを増やす

## ユーザーへの価値

### 1. 意思決定の迅速化

- 「どれだけ条件を変えれば成立するか」が即座にわかる
- 交渉時の目標値が明確になる

### 2. 複数案の比較が容易

- 「売却単価を上げる」「コストを下げる」「ディベ利益を調整する」など、複数の改善策を比較検討できる

### 3. 現実的な判断が可能

- 不足額が土地価値の40%なら「交渉余地が少ない」
- 不足額が土地価値の5%なら「少しの調整で成立」

## 技術的詳細

### 修正ファイル
- `src/utils/calc/landSwap.ts:69-121`

### 影響範囲
- 等価交換シミュレーターのみ
- 他のシナリオ（定期借地権、一括借上）には影響なし

### パフォーマンス
- 計算量の増加は微小（O(1)の追加計算のみ）

## 今後の拡張案

### 1. インタラクティブな調整

```typescript
// 将来的な機能案
interface AdjustmentSuggestion {
  type: 'price' | 'cost' | 'margin';
  currentValue: number;
  requiredValue: number;
  impact: number; // 円単位
  feasibility: 'easy' | 'moderate' | 'difficult'; // 実現可能性
}
```

### 2. 複数シナリオの提案

```
改善案:
1. 売却単価を100千円/㎡引き上げ（実現可能性: 中）
2. 建築コストを10%削減（実現可能性: 低）
3. ディベ利益率を15%→12%に調整（実現可能性: 高）
```

### 3. グラフ表示

- 売却単価 vs NPV のグラフ
- コスト削減率 vs NPV のグラフ
- 感度分析の可視化

## テスト推奨項目

1. **微妙に不成立**（不足額5%以内）
   - 改善案が現実的な数値になっているか

2. **大きく不成立**（不足額50%以上）
   - 改善案が適切に表示されるか
   - NPVが大きな負の値になっているか

3. **成立案件**（従来通り）
   - NPVがプラス
   - 改善案が表示されないこと

---

**実装担当**: Claude Code
**レビュー**: 完了
**次回アクション**: ユーザーフィードバック収集（フェーズ2）
