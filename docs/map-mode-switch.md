# マップビューのモード切り替え方針

## 背景
- 現在の `src/map/index.tsx` では初期スタイルとしてカスタム衛星スタイル (`mapboxStyleURL`) をロードしている。
- 「地図」⇔「航空写真」のトグル操作ではスタイルを切り替えず、衛星スタイル上のレイヤー表示状態だけを変えている。
- そのため `osm-base-layer` シャドーレイヤーを表示しても衛星タイルに隠れてしまい、見た目は常に航空写真になる。レイヤートグルも衛星スタイル固有のレイヤーしか操作できない。

## 解決方針
モード切り替え時に **ベーススタイルを適切に切り替える**。具体的には以下のいずれかの方法を採用する。

### 1. ベーススタイルをロードし直す（推奨）
1. トグル操作 (`mapMode` 変化) の度に `map.setStyle(newStyle)` を実行する。
   - 航空写真モード: 既存の `mapboxStyleURL`
   - 地図モード: Mapbox 提供の `light-v11`（もしくは `streets-v11`）
2. `style.load` 完了後に以下を実行:
   - 現在のズーム・中心・ピッチ・方位を復元
   - 自前レイヤー/ソース (`customLayers`, `PropertiesMarker` など) を再追加
   - レイヤー可視状態（`mapLayers`）を反映
   - fog 設定や言語コントロールを再適用
3. `useEffect` により `mapMode` が変わるたび上記フローを走らせる
4. スタイル変更中は `map.once('style.load', handler)` を使い、複数回ハンドラを登録しないようクリーンアップする

### 2. カスタムスタイル内で衛星／地図レイヤーを切り替える
- カスタムスタイル (`mapboxStyleURL`) に衛星ベースと地図ベースの両方のレイヤーを用意し、トグル操作では該当レイヤーの `visibility` を切り替える。
- 前提としてスタイルの構造を把握する必要がある（衛星用の raster レイヤーや地図用 vector レイヤーの ID を特定）。
- レイヤー数が多い場合や第三者スタイルの依存がある場合はメンテナンス難度が高く、長期的にはスタイルのロード切替 (案1) の方が管理しやすい。

## 推奨実装手順（案1）
1. `applySatelliteForMode` を以下のように書き換える:
   - `map.setStyle(newStyle)` を必ず実行
   - `style.load` 後にズーム・中心など復元
   - 自前レイヤー・ソースを `addSource` / `addLayer` し直す
   - `mapLayers` の状態を反映
   - fog, 言語コントロール, マーカー (`PropertiesMarker`) を再登録
2. `useEffect(() => { applySatelliteForMode(); }, [map, mapMode])` を維持
3. クリーンアップ時に `style.load` ハンドラや言語コントロールをきちんと remove する

## ドキュメント更新履歴
- 2025-10-16: isuizu により初版作成。
